---
title: "Missing value analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse) # Основной пакет
library(readxl) # для чтения файлов экселя xls xlsx
library(skimr)  # для описательной статистики
library(writexl)  # для записи файлов экселя xls xlsx
library(corrr) # для составления корреляционной матрицы
library(pheatmap) # для постройки хитмэпа
library(flextable) # для красивых таблиц
library(ggExtra) # для соединения графиков
library(GGally)
library(corrplot)
library(mice)
```

```{r, echo = FALSE}
#Чтение данных
vis_all <- read_csv("data/raw/vis_all.csv", show_col_types = FALSE)

#Удаляем дубликаты: 548 и 580 строки

vis_all <- vis_all %>%
  group_by(id) %>%
  filter(!(id == 548 & row_number() == 2),
         !(id == 580 & row_number() == 2)) %>%
  ungroup() %>%
  select(sort(names(.)))
```


```{r, echo = FALSE}
#Первоначальная Проверка статистик выборки. В работе...
skim(vis_all)
```


```{r, echo = FALSE}
# Исключаем целевые переменные из датасета перед импутацией
imp_data <- vis_all %>%
  select(-mmse_v8, -moca_v8, -fab_v8, -stsutiational_v8, - stpersonal_v8, -symboldigit_v8, -bdi_v8, -mmse__cl, -moca_cl, -cognitiveimpairment_cl, -memoryloss, -memorylosstime, -memoryloss_cl)

```

# Импутация данных

```{r, eval = FALSE, include = FALSE}


# Настройка матрицы предикторов "все от всего"
predictor_matrix <- quickpred(imp_data, exclude = "id")

imputed_data <- mice(
  imp_data,
  m = 10,
  method = "pmm",
  predictorMatrix = predictor_matrix,
  maxit = 10,
  seed = 123
)


completed_data <- complete(imputed_data, action = 1)

#write.csv(completed_data, "imputed_wide_data.csv", row.names = FALSE)
```

```{r, echo = FALSE}
#Загрузка восполненного датасета из файла
imputed_data <- read_csv("data/raw/imputed_wide_data.csv", show_col_types = FALSE)
skim(imputed_data)
```

```{r, echo = FALSE}
#Удаляем дубликаты: 548 и 580 строки

imputed_data <- imputed_data %>%
  group_by(id) %>%
  filter(!(id == 548 & row_number() == 2),
         !(id == 580 & row_number() == 2)) %>%
  ungroup()

```


```{r, echo = FALSE}
#Расчет переменных ИМТ, "САД" - среднее артериальное давление, индекс атерогенности

imputed_data$bmi_v1 <- round(imputed_data$weight_v1 / ((imputed_data$height_v1 / 100) ^ 2), 3)
imputed_data$sad_v1 <- round((1 / 3 * imputed_data$sbp_v1) + (2 / 3 * imputed_data$dbp_v1), 3)
imputed_data$athero_index_v1 <- round((imputed_data$cholesterol_v1 - imputed_data$hdl_v1) / imputed_data$hdl_v1, 3)

imputed_data$bmi_v2 <- round(imputed_data$weight_v2 / ((imputed_data$height_v2 / 100) ^ 2), 3)
imputed_data$sad_v2 <- round((1 / 3 * imputed_data$sbp_v2) + (2 / 3 * imputed_data$dbp_v2), 3)
imputed_data$athero_index_v2 <- round((imputed_data$cholesterol_v2 - imputed_data$hdl_v2) / imputed_data$hdl_v2, 3)

imputed_data$bmi_v3 <- round(imputed_data$weight_v3 / ((imputed_data$height_v3 / 100) ^ 2), 3)
imputed_data$sad_v3 <- round((1 / 3 * imputed_data$sbp_v3) + (2 / 3 * imputed_data$dbp_v3), 3)
imputed_data$athero_index_v3 <- round((imputed_data$cholesterol_v3 - imputed_data$hdl_v3) / imputed_data$hdl_v3, 3)

imputed_data$bmi_v4 <- round(imputed_data$weight_v4 / ((imputed_data$height_v4 / 100) ^ 2), 3)
imputed_data$sad_v4 <- round((1 / 3 * imputed_data$sbp_v4) + (2 / 3 * imputed_data$dbp_v4), 3)
imputed_data$athero_index_v4 <- round((imputed_data$cholesterol_v4 - imputed_data$hdl_v4) / imputed_data$hdl_v4, 3)

imputed_data$bmi_v5 <- round(imputed_data$weight_v5 / ((imputed_data$height_v5 / 100) ^ 2), 3)
imputed_data$sad_v5 <- round((1 / 3 * imputed_data$sbp_v5) + (2 / 3 * imputed_data$dbp_v5), 3)
imputed_data$athero_index_v5 <- round((imputed_data$cholesterol_v5 - imputed_data$hdl_v5) / imputed_data$hdl_v5, 3)

imputed_data$bmi_v6 <- round(imputed_data$weight_v6 / ((imputed_data$height_v6 / 100) ^ 2), 3)
imputed_data$sad_v6 <- round((1 / 3 * imputed_data$sbp_v6) + (2 / 3 * imputed_data$dbp_v6), 3)
imputed_data$athero_index_v6 <- round((imputed_data$cholesterol_v6 - imputed_data$hdl_v6) / imputed_data$hdl_v6, 3)

imputed_data$bmi_v7 <- round(imputed_data$weight_v7 / ((imputed_data$height_v7 / 100) ^ 2), 3)
imputed_data$sad_v7 <- round((1 / 3 * imputed_data$sbp_v7) + (2 / 3 * imputed_data$dbp_v7), 3)
imputed_data$athero_index_v7 <- round((imputed_data$cholesterol_v7 - imputed_data$hdl_v7) / imputed_data$hdl_v7, 3)

imputed_data$bmi_v8 <- round(imputed_data$weight_v8 / ((imputed_data$height_v8 / 100) ^ 2), 3)
imputed_data$sad_v8 <- round((1 / 3 * imputed_data$sbp1_v8) + (2 / 3 * imputed_data$dbp1_v8), 3)
imputed_data$athero_index_v8 <- round((imputed_data$cholesterol_v8 - imputed_data$hdl_v8) / imputed_data$hdl_v8, 3)

```

# Датасеты для целевых переменных

###Список целевых переменных
###mmse_v8, moca_v8, fab_v8, stsutiational_v8, stpersonal_v8 и symboldigit_v8, bdi_v8

## Датасет для целевой переменной mmse

```{r, echo = FALSE}
mmse_data <- vis_all %>%
  select(id, mmse_v8)
mmse_data <- mmse_data %>%
  right_join(imputed_data, by = 'id') %>%
  filter(!is.na(mmse_v8)) 
#skim(mmse_data)
```

## Датасет для целевой переменной moca

```{r}
moca_data <- vis_all %>%
  select(id, moca_v8)
moca_data <- moca_data %>%
  right_join(imputed_data, by = 'id') %>%
  filter(!is.na(moca_v8)) 
```

## Датасет для целевой переменной fab

```{r}
fab_data <- vis_all %>%
  select(id, fab_v8)
fab_data <- fab_data %>%
  right_join(imputed_data, by = 'id') %>%
  filter(!is.na(fab_v8)) 
```

## Датасет для целевой переменной stsutiational

```{r}
stsutiational_data <- vis_all %>%
  select(id, stsutiational_v8)
stsutiational_data <- stsutiational_data %>%
  right_join(imputed_data, by = 'id') %>%
  filter(!is.na(stsutiational_v8)) 
```

## Датасет для целевой переменной stpersonal & symboldigit

```{r}
stpersonal_symboldigit_data <- vis_all %>%
  select(id, stpersonal_v8, symboldigit_v8)
stpersonal_symboldigit_data <- stpersonal_symboldigit_data %>%
  right_join(imputed_data, by = 'id') %>%
  filter(!is.na(stpersonal_v8)) #Здесь сделал одну переменную, т.к. они заполнены или пропущены вместе
```

## Датасет для целевой переменной bdi_v8

```{r}
bdi_data <- vis_all %>%
  select(id, bdi_v8)
bdi_data <- bdi_data %>%
  right_join(imputed_data, by = 'id') %>%
  filter(!is.na(bdi_v8)) 
```



