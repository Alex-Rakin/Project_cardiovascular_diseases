---
title: "Missing value analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse) # Основной пакет
library(readxl) # для чтения файлов экселя xls xlsx
library(skimr)  # для описательной статистики
library(writexl)  # для записи файлов экселя xls xlsx
library(corrr) # для составления корреляционной матрицы
library(pheatmap) # для постройки хитмэпа
library(flextable) # для красивых таблиц
library(ggExtra) # для соединения графиков
library(GGally)
library(corrplot)
library(mice)
```

```{r, echo = FALSE}
#Чтение данных
vis_all <- read_csv("data/raw/vis_all.csv", show_col_types = FALSE)
```


```{r}
#Анализ пропусков

#Взяты все строки кроме NA в moca
#filtered_vis_all <- vis_all[!is.na(vis_all$moca_v8), ] 

# Взяты все строки кроме NA в mmse_v8, moca_v8, fab_v8, stsutiational_v8, stpersonal_v8 и symboldigit_v8, bdi_v8
vars_keep <- c("mmse_v8", "moca_v8", "fab_v8", 
               "stsutiational_v8", "stpersonal_v8", 
               "symboldigit_v8", "bdi_v8")
filtered_vis_all <- vis_all[rowSums(!is.na(vis_all[, vars_keep])) > 0, ]

#Выбор только целевых переменных и предикторов
filtered_vis_all <- filtered_vis_all[, c("id", names(filtered_vis_all)[grepl("smoking_|alcohol_|height|weight|sbp|dbp|pulse|cholesterol|hdl|mmse_v8|moca_v8|fab_v8|stsutiational_v8|stpersonal_v8|symboldigit_v8|bdi_v8", names(filtered_vis_all))])] 
filtered_vis_all <- filtered_vis_all %>%
  select(-agesmoking_v7, -yearsmoking_v7)

#Выбор только целевых переменных и предикторов +курение и алкоголь
#filtered_vis_all <- filtered_vis_all[, c("id", #names(filtered_vis_all)[grepl("smoking_|alcohol_|height|weight|sbp|dbp|pulse|cholesterol|hdl|mmse_v8|moca_v8|fab_v8|stsutiational_v8|stpersonal_v8|symboldigit_v8|bdi_v8", #names(filtered_vis_all))])] 
#filtered_vis_all <- filtered_vis_all %>%
#  select(-agesmoking_v7, -yearsmoking_v7)

md.pattern(filtered_vis_all, rotate.names = TRUE)
```
# Первый вариант импутации

```{r}
#Построение матрицы импутации
predictor_matrix <- make.predictorMatrix(filtered_vis_all)

# Обнуление строк переменных позволяет использовать их в качестве предикторов, в то же время не дает восполнять в них пропуски??
predictor_matrix["id", ] <- 0
predictor_matrix[, "id"] <- 0

#predictor_matrix["mmse_v8", ] <- 0
#predictor_matrix["moca_v8", ] <- 0
#predictor_matrix["fab_v8", ] <- 0
#predictor_matrix["stsutiational_v8", ] <- 0
#predictor_matrix["stpersonal_v8", ] <- 0
#predictor_matrix["symboldigit_v8", ] <- 0
#predictor_matrix["bdi_v8", ] <- 0

#predictor_matrix[, "mmse_v8"] <- 0
#predictor_matrix[, "moca_v8"] <- 0
#predictor_matrix[, "fab_v8"] <- 0
#predictor_matrix[, "stsutiational_v8"] <- 0
#predictor_matrix[, "stpersonal_v8"] <- 0
#predictor_matrix[, "symboldigit_v8"] <- 0
#predictor_matrix[, "bdi_v8"] <- 0

print(predictor_matrix)

#id, mmse_v8, moca_v8, fab_v8, stsutiational_v8, stpersonal_v8 и symboldigit_v8, bdi_v8
```

```{r}
method <- rep("pmm", ncol(filtered_vis_all))
names(method) <- colnames(filtered_vis_all)

# Отключаем импутацию для целевых переменных
method[c("id", "mmse_v8", "moca_v8", "fab_v8", 
         "stsutiational_v8", "stpersonal_v8", 
         "symboldigit_v8", "bdi_v8")] <- ""

imputed_data <- mice(
  filtered_vis_all,
  m = 2,
  predictorMatrix = predictor_matrix,
  method = method,  
  maxit = 2,
  printFlag = TRUE,
  seed = 123
)

```

```{r}
imputed_data_1 <- complete(imputed_data, action = 1)
md.pattern(imputed_data_1, rotate.names = TRUE)
```

```{r, eval = FALSE, include = FALSE}
# 1. Сохранение в RDS
saveRDS(imputed_data, file = "data/raw/imputed_data_mids_raw.rds")
```

```{r, eval = FALSE, include = FALSE}
# 2. Сохранения ДС в длинном формате

imputed_data_long <- complete(imputed_data, action = "long", include = TRUE)

#write.csv(imputed_data_long, "data/raw/imputed_data_long.csv", row.names = FALSE)
```

```{r, echo = FALSE}
#Расчет переменных ИМТ, "САД" - среднее артериальное давление, индекс атерогенности

imputed_data_long$bmi_v1 <- round(imputed_data_long$weight_v1 / ((imputed_data_long$height_v1 / 100) ^ 2), 3)
imputed_data_long$sad_v1 <- round((1 / 3 * imputed_data_long$sbp_v1) + (2 / 3 * imputed_data_long$dbp_v1), 3)
imputed_data_long$athero_index_v1 <- round((imputed_data_long$cholesterol_v1 - imputed_data_long$hdl_v1) / imputed_data_long$hdl_v1, 3)

imputed_data_long$bmi_v2 <- round(imputed_data_long$weight_v2 / ((imputed_data_long$height_v2 / 100) ^ 2), 3)
imputed_data_long$sad_v2 <- round((1 / 3 * imputed_data_long$sbp_v2) + (2 / 3 * imputed_data_long$dbp_v2), 3)
imputed_data_long$athero_index_v2 <- round((imputed_data_long$cholesterol_v2 - imputed_data_long$hdl_v2) / imputed_data_long$hdl_v2, 3)

imputed_data_long$bmi_v3 <- round(imputed_data_long$weight_v3 / ((imputed_data_long$height_v3 / 100) ^ 2), 3)
imputed_data_long$sad_v3 <- round((1 / 3 * imputed_data_long$sbp_v3) + (2 / 3 * imputed_data_long$dbp_v3), 3)
imputed_data_long$athero_index_v3 <- round((imputed_data_long$cholesterol_v3 - imputed_data_long$hdl_v3) / imputed_data_long$hdl_v3, 3)

imputed_data_long$bmi_v4 <- round(imputed_data_long$weight_v4 / ((imputed_data_long$height_v4 / 100) ^ 2), 3)
imputed_data_long$sad_v4 <- round((1 / 3 * imputed_data_long$sbp_v4) + (2 / 3 * imputed_data_long$dbp_v4), 3)
imputed_data_long$athero_index_v4 <- round((imputed_data_long$cholesterol_v4 - imputed_data_long$hdl_v4) / imputed_data_long$hdl_v4, 3)

imputed_data_long$bmi_v5 <- round(imputed_data_long$weight_v5 / ((imputed_data_long$height_v5 / 100) ^ 2), 3)
imputed_data_long$sad_v5 <- round((1 / 3 * imputed_data_long$sbp_v5) + (2 / 3 * imputed_data_long$dbp_v5), 3)
imputed_data_long$athero_index_v5 <- round((imputed_data_long$cholesterol_v5 - imputed_data_long$hdl_v5) / imputed_data_long$hdl_v5, 3)

imputed_data_long$bmi_v6 <- round(imputed_data_long$weight_v6 / ((imputed_data_long$height_v6 / 100) ^ 2), 3)
imputed_data_long$sad_v6 <- round((1 / 3 * imputed_data_long$sbp_v6) + (2 / 3 * imputed_data_long$dbp_v6), 3)
imputed_data_long$athero_index_v6 <- round((imputed_data_long$cholesterol_v6 - imputed_data_long$hdl_v6) / imputed_data_long$hdl_v6, 3)

imputed_data_long$bmi_v7 <- round(imputed_data_long$weight_v7 / ((imputed_data_long$height_v7 / 100) ^ 2), 3)
imputed_data_long$sad_v7 <- round((1 / 3 * imputed_data_long$sbp_v7) + (2 / 3 * imputed_data_long$dbp_v7), 3)
imputed_data_long$athero_index_v7 <- round((imputed_data_long$cholesterol_v7 - imputed_data_long$hdl_v7) / imputed_data_long$hdl_v7, 3)

imputed_data_long$bmi_v8 <- round(imputed_data_long$weight_v8 / ((imputed_data_long$height_v8 / 100) ^ 2), 3)
imputed_data_long$sad_v8 <- round((1 / 3 * imputed_data_long$sbp1_v8) + (2 / 3 * imputed_data_long$dbp1_v8), 3)
imputed_data_long$athero_index_v8 <- round((imputed_data_long$cholesterol_v8 - imputed_data_long$hdl_v8) / imputed_data_long$hdl_v8, 3)

```

```{r}
colnames(imputed_data_long)
```
# Длинный формат данных

```{r}
imputed_data_long <- imputed_data_long %>%
  select(.id, .imp, id, mmse_v8, moca_v8, fab_v8, stsutiational_v8, stpersonal_v8, symboldigit_v8, bdi_v8,
         matches("smoking_|alcohol_|pulse|athero_index|sad|bmi"))
colnames(imputed_data_long)
```

# Ещё длиннее формат данны

```{r}
imputed_data_longest <- imputed_data_long %>%
  pivot_longer(
    cols = -c(.id, .imp, id),
    names_pattern = "(.+)_(v[0-9]+)",
    names_to = c(".value", "id_point")
  )
colnames(imputed_data_longest)
```

```{r}
# Сшиваем imputed_data_longest обратно в <<<MIDS ДЛЯ ПОСТРОЕНИЯ МОДЕЛЕЙ>>>
imputed_data_wide <- imputed_data_longest %>%
  pivot_wider(
    names_from = "id_point", 
    values_from = -c(.id, .imp, id, id_point)  # Здесь мы выбираем все колонки, кроме идентификаторов
  )

imputed_data_mids <- as.mids(imputed_data_wide)
```




```{r, eval = FALSE, include = FALSE}
# 4. Расчет среднего значения каждого предиктора на каждом визите из 10 восполненных 

#imputed_data_mean_long <- imputed_data_long %>%
#  group_by(.id, .imp) %>%  # Группируем по пациенту и номеру импутации
#  summarise(across(where(is.numeric), ~mean(.x, na.rm = TRUE)), .groups = "drop")

imputed_data_mean_long <- imputed_data_long %>%
  group_by(.id) %>%  # Только по пациенту, без учета импутаций
  summarise(across(where(is.numeric), ~mean(.x, na.rm = TRUE)), .groups = "drop")


write.csv(imputed_data_mean_long, "data/raw/imputed_data_mean_long.csv", row.names = FALSE)
```


```{r, echo = FALSE}
#Загрузка восполненного усредненного датасета из файла

imputed_data_mean_long <- read_csv("data/raw/imputed_data_mean_long.csv", show_col_types = FALSE)
skim(imputed_data_mean_long)
```





```{r}
# Берем те переменные, которые нужно добавить к восполненному датасету

filtered_vis_all_add <- filtered_vis_all %>%
  select(id, mmse_v8, fab_v8, stsutiational_v8, stpersonal_v8, symboldigit_v8, bdi_v8)
df_combined <- bind_cols(imputed_data_mean_long, filtered_vis_all_add)


#df_combined <- df_combined %>%
# select(id, )
```

# Конец

```{r}
# Собираем восполненный датасет и целевые переменные

df_combined <- df_combined[, c("id", sort(names(df_combined)[grepl("sad|bmi|athero_index|pulse|mmse_v8|moca_v8|fab_v8|stsutiational_v8|stpersonal_v8|symboldigit_v8|bdi_v8", names(df_combined))]))]
 
```








# Датасеты для целевых переменных

###Список целевых переменных
###mmse_v8, moca_v8, fab_v8, stsutiational_v8, stpersonal_v8 и symboldigit_v8, bdi_v8

## Датасет для целевой переменной mmse

```{r, echo = FALSE}
mmse_data <- vis_all %>%
  select(id, mmse_v8)
mmse_data <- mmse_data %>%
  right_join(imputed_data, by = 'id') %>%
  filter(!is.na(mmse_v8)) 
#skim(mmse_data)
```

## Датасет для целевой переменной moca

```{r}
moca_data <- vis_all %>%
  select(id, moca_v8)
moca_data <- moca_data %>%
  right_join(imputed_data, by = 'id') %>%
  filter(!is.na(moca_v8)) 
```

## Датасет для целевой переменной fab

```{r}
fab_data <- vis_all %>%
  select(id, fab_v8)
fab_data <- fab_data %>%
  right_join(imputed_data, by = 'id') %>%
  filter(!is.na(fab_v8)) 
```

## Датасет для целевой переменной stsutiational

```{r}
stsutiational_data <- vis_all %>%
  select(id, stsutiational_v8)
stsutiational_data <- stsutiational_data %>%
  right_join(imputed_data, by = 'id') %>%
  filter(!is.na(stsutiational_v8)) 
```

## Датасет для целевой переменной stpersonal & symboldigit

```{r}
stpersonal_symboldigit_data <- vis_all %>%
  select(id, stpersonal_v8, symboldigit_v8)
stpersonal_symboldigit_data <- stpersonal_symboldigit_data %>%
  right_join(imputed_data, by = 'id') %>%
  filter(!is.na(stpersonal_v8)) #Здесь сделал одну переменную, т.к. они заполнены или пропущены вместе
```

## Датасет для целевой переменной bdi_v8

```{r}
bdi_data <- vis_all %>%
  select(id, bdi_v8)
bdi_data <- bdi_data %>%
  right_join(imputed_data, by = 'id') %>%
  filter(!is.na(bdi_v8)) 
```



